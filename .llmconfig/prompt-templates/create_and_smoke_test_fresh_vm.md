# Task: Create a Fresh Vagrant Ubuntu 24.04 VM and Smoke-Test It

You are the `fresh-env-creator` agent.

## Mission Overview
Initialize a new sandbox project using Vagrant and Ubuntu 24.04 LTS. Then, verify the environment boots correctly with SSH access and self-heals known issues in a fresh setup.

---

### STEP A: Initialize Vagrant Environment

1. Ensure git working directory is clean: abort if there are uncommitted changes.
2. Generate a new Vagrant environment:
   ```bash
   mkdir -p new-vm-test && cd new-vm-test
   git init
   vagrant init hashicorp-education/ubuntu-24-04 --box-version 0.1.0
   git add Vagrantfile
   git commit -m "feat: initialize fresh Ubuntu 24.04 Vagrantfile from scratch"
   ```

**ðŸ“Œ Rationale:** As of Ubuntu 24.04, Canonical no longer publishes Vagrant boxes; the `hashicorp-education/ubuntu-24-04` box is the best available source from official Packer builds.

---

### STEP B: Bring Up VM and Self-Heal Provisioning

Run:

```bash
vagrant up --provider=virtualbox
```

* **If exit code = 0:** proceed to STEP C.
* **On failure** (look at STDERR):

  * **If seen:** "VirtualBox Guest Additions build failed", "headers/ dkms missing"

    * Update provisioning block (either inline or shell) to include:

      ```bash
      sudo apt update && sudo apt install -y build-essential dkms linux-headers-$(uname -r)
      ```
    * Commit changes:

      ```bash
      git add Vagrantfile
      git commit -m "fix: add build-essential, dkms, linux-headers for Guest Additions"
      ```
    * Rerun `vagrant up` once.

  * **If seen:** "cannot find box" for Ubuntu 24.04

    * Ensure box name is `hashicorp-education/ubuntu-24-04` (correct fallback).
    * If different, update it and commit:

      ```bash
      git add Vagrantfile
      git commit -m "fix: set proper Ubuntu 24.04 fallback base box from hashicorp-education"
      ```
    * Retry `vagrant up`.

---

### STEP C: SSH Smoke Test

Once `vagrant up` succeeds:

```bash
vagrant ssh -c "uname -r && echo fresh-test: VM booted and SSH accessible"
```

* **On success:** log success message.
* **If SSH fails:** capture error lines, diagnose authentication or network; do **not pause the script** unless the failure message is ambiguous. Log action attempt.

---

### STEP D: Push and Log

If Git remote exists:

```bash
git push origin HEAD
```

Else:

```bash
echo "fresh-env-creator: No remote detected â€” changes remain local"
```

---

### âœ… Behavioral Rules

* This is a **fresh, isolated project** â€” do not reference existing code or configurations.
* All commits must be atomic and meaningful (initial scaffolding or self-healing only).
* Logs and repo must remain clean: do **not include** autogenerated logs, CLI debug dumps, or `.ARG-files.log`.
* Always use structured or single-line log markers.

---

### ðŸ“Œ Why This Template Is Essential

* Ubuntu 24.04 **does not provide official Vagrant images**, so using `hashicorp-education/ubuntu-24-04` is necessary provenance.
* VirtualBox on Ubuntu 24.04 often fails to build Guest Additions due to missing kernel headers and build tools; installing `build-essential`, `dkms`, and matching `linux-headers` resolves most failures.

---

When run successfully, the environment-verifier should produce a fresh Vagrant directory, validated Ubuntu 24.04 VM, and necessary commit historyâ€”ready for further sandbox lifecycle testing.

â€” End of Prompt â€”