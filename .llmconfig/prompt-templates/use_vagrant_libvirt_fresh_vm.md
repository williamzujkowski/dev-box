# Task: Use KVM/QEMU + libvirt provider with Vagrant to spin up Ubuntu 24.04 LTS VM

You are the `libvirt-fresh-test` agent. Your objective is to demonstrably spin
up a clean Ubuntu 24.04 VM using Vagrant and the **libvirt** provider
(KVM/QEMU), including setup, provisioning validation, self-healing, and commit
history.

---

## STEP 0: Host & Hypervisor Requirements

1. If `/dev/kvm` does not exist or `vagrant plugin list` shows no
   `vagrant-libvirt`, install prerequisites:

   ```bash
   sudo apt update
   sudo apt install -y qemu-kvm libvirt-daemon-system libvirt-clients \
     ruby-dev libvirt-dev build-essential dnsmasq-base ebtables \
     libxslt-dev libxml2-dev zlib1g-dev nfs-kernel-server
   sudo systemctl enable --now libvirtd
   sudo usermod -aG libvirt $USER
   ```

   This ensures KVM/libvirt are installed and available for Vagrant.

2. If `vagrant plugin list` does not include `vagrant-libvirt`:
   ```bash
   vagrant plugin install vagrant-libvirt
   ```
   Requires earlier installed libvirt and ruby-libvirt dev libraries.

## STEP 1: Initialize Vagrant Configuration

1. Ensure git working tree is clean. If dirty, commit with:

   ```bash
   git add -A
   git commit -m "chore: clean working directory before libvirt test"
   ```

2. Scaffold new VM test area:
   ```bash
   mkdir -p libvirt-fresh-vm && cd libvirt-fresh-vm
   git init
   vagrant init hashicorp-education/ubuntu-24-04 --provider=libvirt
   git add Vagrantfile
   git commit -m "feat: initialize Ubuntu 24.04 Vagrantfile using libvirt provider"
   ```
   Using `hashicorp-education/ubuntu-24-04` since Canonical does not publish its
   own 24.04 boxes.

## STEP 2: Bring Up VM & Policy-Based Self-Healing

1. Attempt:

   ```bash
   vagrant up --provider=libvirt
   ```

   On success ‚Üí proceed to STEP 3.

2. On failure (pattern matching):

   **If missing dnsmasq, ruby-libvirt, or KVM-unrelated errors:**

   ```bash
   sudo apt update && sudo apt install -y dnsmasq-base ebtables ruby-libvirt
   vagrant up --provider=libvirt || true
   git add .
   git commit -m "fix: install libvirt plugin prerequisites (ruby-libvirt, dnsmasq, ebtables)"
   ```

   **Guest Additions or shared folder provisioning error inside VM?** Use
   provisioning snippet:

   ```bash
   sudo apt update && sudo apt install -y build-essential dkms linux-headers-$(uname -r)
   ```

   Insert into Vagrantfile or inline shell provisioner, commit:

   ```bash
   git commit -m "fix: install build-essential, dkms, linux-headers for guest tools"
   ```

   Then:

   ```bash
   vagrant reload --provision
   ```

   **If box version mismatch or download issue:** Update `config.vm.box_version`
   to match cloud-image version and commit:

   ```bash
   git commit -m "fix: adjust Ubuntu 24.04 box version to match libvirt-compatible hashicorp cloud image"
   ```

   Retry bring-up.

## STEP 3: SSH Smoke Tests inside Guest

1. Once VM starts:

   ```bash
   vagrant ssh -c "uname -r && echo libvirt-fresh-test: VM version OK"
   vagrant ssh -c "lsmod | grep vboxguest && echo 'Guest additions loaded' || echo 'Skipping guest tools'"
   ```

   Log output including headers, kernel version, and whether virtuallab guest
   modules loaded.

2. For further dev readiness checks:
   ```bash
   vagrant ssh -c "which python3 node || echo 'Dev toolkit missing'"
   ```
   If missing, install:
   ```bash
   vagrant ssh -c "sudo apt update && sudo apt install -y python3 nodejs npm curl git htop"
   ```
   Commit remediation:
   ```bash
   git commit -m "feat: ensure basic dev tools installed"
   ```

## STEP 4: Final Status, Tagging & Cleanup

1. If VM boot and checks succeed:

   ```bash
   git commit --allow-empty -m "chore: libvirt Ubuntu 24.04 smoke test passed cleanly"
   git tag smoke-test/libvirt/$(date +%Y%m%dT%H%M%SZ)
   ```

2. If a remote origin exists:

   ```bash
   git push origin HEAD --tags
   ```

   Else: log:

   ```
   libvirt-fresh-test: no remote defined ‚Äî commit pending push
   ```

3. Destroy VM to restore host state:

   ```bash
   vagrant destroy -f
   ```

4. Exit with code 0 if all passed; else 1 for operator review.

## üß† Behavior Rules

- **Limit to at most two commits:** (1) Vagrant init, (2) any self-healing
  action.
- **Never commit** sensitive logs, CLI history dumps, or autogenerated
  artifacts.
- **Logging** should be structured or human-readable single lines prefixed with
  agent identity.
- **If provisioning error** is ambiguous or non-patternized, log details and ask
  for human confirmation.

## üìå Why This Prompt Matters

1. **VirtualBox is broken** in Ubuntu 24.04 due to KVM root-mode conflicts
   (`VERR_VMX_IN_VMX_ROOT_MODE`) ‚Äî libvirt directly uses KVM and avoids such
   issues entirely.

2. **Canonical does not publish** 24.04 Vagrant boxes, requiring fallback to
   `hashicorp-education/ubuntu-24-04` Packer-built boxes that support libvirt
   provider.

3. **Vagrant-libvirt plugin** has strict dependency requirements; installed via
   distribution packages and `vagrant plugin install vagrant-libvirt`. Using gem
   installations can cause compatibility issues.

## üöÄ Enhanced Features for Ubuntu 24.04 + KVM Integration

### Pre-flight KVM Verification

```bash
# Verify KVM is available and functional
if [ ! -c /dev/kvm ]; then
    echo "‚ùå /dev/kvm not available - KVM not properly installed"
    exit 1
fi

# Check CPU virtualization support
if grep -q vmx /proc/cpuinfo; then
    echo "‚úÖ Intel VT-x detected"
elif grep -q svm /proc/cpuinfo; then
    echo "‚úÖ AMD-V detected"
else
    echo "‚ùå Hardware virtualization not supported"
    exit 1
fi

# Verify libvirt service
if ! systemctl is-active --quiet libvirtd; then
    echo "‚ö†Ô∏è  libvirtd not running - attempting to start"
    sudo systemctl start libvirtd
fi
```

### Enhanced Vagrantfile Template

```ruby
# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure("2") do |config|
  # Ubuntu 24.04 LTS via hashicorp-education (libvirt compatible)
  config.vm.box = "hashicorp-education/ubuntu-24-04"
  config.vm.box_version = "0.1.0"

  # VM hostname
  config.vm.hostname = "ubuntu-24-04-libvirt"

  # Libvirt provider configuration
  config.vm.provider :libvirt do |libvirt|
    libvirt.driver = "kvm"
    libvirt.memory = 2048
    libvirt.cpus = 2
    libvirt.machine_type = "pc-i440fx-2.11"
    libvirt.cpu_mode = "host-passthrough"
    libvirt.nested = true
    libvirt.volume_cache = "writeback"
  end

  # Network configuration
  config.vm.network "private_network", ip: "192.168.121.10"

  # Self-healing provisioning
  config.vm.provision "shell", inline: <<-SHELL
    export DEBIAN_FRONTEND=noninteractive

    # System updates
    apt-get update -y
    apt-get upgrade -y

    # Essential development tools
    apt-get install -y \
      curl \
      wget \
      git \
      vim \
      htop \
      build-essential \
      python3 \
      python3-pip \
      nodejs \
      npm

    # Create workspace
    mkdir -p /home/vagrant/workspace
    chown vagrant:vagrant /home/vagrant/workspace

    echo "‚úÖ Ubuntu 24.04 VM with libvirt provider ready!"
    echo "üìä System: $(lsb_release -d | cut -f2)"
    echo "üîß Hypervisor: $(systemd-detect-virt)"
    echo "üíæ Memory: $(free -h | grep Mem | awk '{print $2}')"
    echo "üñ•Ô∏è  CPUs: $(nproc)"
  SHELL
end
```

### Comprehensive Testing Suite

```bash
#!/bin/bash
# libvirt-vm-test.sh - Comprehensive testing for libvirt VM

echo "üß™ Starting libvirt Ubuntu 24.04 VM tests..."

# Test 1: VM provider verification
vagrant ssh -c "systemd-detect-virt" | grep -q "kvm" && echo "‚úÖ KVM hypervisor confirmed"

# Test 2: Performance verification
vagrant ssh -c "cat /proc/cpuinfo | grep -c processor" | grep -q "2" && echo "‚úÖ CPU allocation verified"

# Test 3: Network connectivity
vagrant ssh -c "ping -c 1 8.8.8.8 >/dev/null 2>&1" && echo "‚úÖ Internet connectivity"

# Test 4: Development tools
vagrant ssh -c "python3 --version && node --version && npm --version" && echo "‚úÖ Dev tools installed"

# Test 5: Shared folders (if configured)
vagrant ssh -c "ls -la /vagrant >/dev/null 2>&1" && echo "‚úÖ Shared folders working" || echo "‚ÑπÔ∏è  No shared folders configured"

echo "üéâ All libvirt VM tests completed!"
```

## üîÑ Migration from VirtualBox

For projects currently using VirtualBox, this template provides a seamless
migration path:

1. **Backup existing VirtualBox VMs** (if needed)
2. **Install libvirt prerequisites** (Step 0)
3. **Create new libvirt-based Vagrant project** (Step 1)
4. **Migrate configurations** (network, provisioning, etc.)
5. **Test thoroughly** with comprehensive smoke tests
6. **Document changes** in commit history

This approach **completely bypasses** the VirtualBox + KVM conflicts in Ubuntu
24.04 while providing **superior performance** through native KVM integration!
